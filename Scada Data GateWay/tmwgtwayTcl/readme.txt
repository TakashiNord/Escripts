
Предназначение:
Приложение предназначено для разработчиков (отладка и тестирование).
В полуавтоматическом режиме формирует таблицу для файла данных программы "SCADA Data Gateway".


Соглашения:
 а) необходимо запускать данное приложение при созданном направлении  ODBC = rsdu2, то-есть, при установленном клиенте РСДУ.
 б) Для подключения к БД используется схема RSDUADMIN.


====================================================================================
Последовательность работы.
---------------------------------------------------------

0. Завершить работу программы tmwgtway.exe.

1. Далее, необходимо открыть папку "Program Files\Triangle MicroWorks\SCADA Data Gateway" и удалить (или переместить в другое место) следующие файлы:  
   tmwgtway.csv
   tmwgtway.ini

Примечание: Настройки программы SCADA Data Gateway хранятся в 2-х файлах 
    tmwgtway.csv - собственно , это список элементов
    tmwgtway.ini - в этом файле формируется список каналов и их свойств

2. запустить tmwgtway.exe, для того чтобы, SCADA заново пересоздала и переинициализировала удаленные файлы.
SCADA Data Gateway предложит создать новый канал - откажитесь.
Завершите программу - выбрав меню File->Exit with Save.

3. Запустить run.cmd. Скрипт по данным из таблиц БД: da_dev_desc, da_param, da_slave сформирует файл tmwgtway_rsdu2.txt

5. Открыть файл tmwgtway_rsdu2.txt

файл состоит из записей вида:

.....

6=Сбор с D200 (основной)                  =10.100.1.10:2404
Протокол = {IEC60870-5-104 (48)}
Адреса = {1 (239)} {11 (1303)}
Alias=SBOR6

TI8201,,,,,,,,,SBOR6,4,1,11,8201,,,"rand(0, 500, 90000)",,,TI8201,
TI8202,,,,,,,,,SBOR6,4,1,11,8202,,,"if(rand(0, 3, 90000),1,0)",,,TI8202,
TI8203,,,,,,,,,SBOR6,4,1,11,8203,,,"rand(0,1,600000)",,,TI8203,
TI8204,,,,,,,,,SBOR6,4,1,11,8204,,,"rand(1,3500, 600000)*0.01",,,TI8204,
TI8205,,,,,,,,,SBOR6,4,1,11,8205,,,"rand(1, 100, 200000)",,,TI8205,
TI8206,,,,,,,,,SBOR6,4,1,11,8206,,,"rand(0,1000,20000)",,,TI8206,
.....

В этих записях, указан протокол {Протокол МЭК870-5-104} , Общие адреса { 1 11 }, и alias направления {SBOR6}, а также ip:port


6. Основной принцип дальнейшей подготовительной работы заключается в том, что вам необходимо выбрать те направления, 
которые Вам нужны и их поддерживает Scada.
А именно,
 - МЭК-104
 - МЭК-103
 - МЭК-101
 - Modbus (RTU,TCP)
Например, счетчики ION - SCADA не поддерживает

Для этого запустив, tmwgtway.exe, необходимо создать вручную структуру опрашиваемых протоколов используя в качестве исходных данных файл tmwgtway_rsdu2.txt.

SBOR6  - S104
 L4
   A1 
SBOR15  - S101
 L1
   A1
 L2
   A1
 L3
SBOR18   - modbus
 L0
 L1

Для этого, Вам необходимы
 Протокол
 Alias - название из файла tmwgtway_rsdu2.txt,
 Ip    - адрес
 port  - порт
 общие адреса

желательно, также создать элементы Data.

После воссоздания структуры, её необходимо сохранить. И завершить программу SCADA Data Gateway.

на этом этапе 
 сохранит в tmwgtway.ini - свою собственную массивную область памяти необходимые данные (протоколы и данные)
Файл tmwgtway.csv - будет содержать список каналов


7. Открыть файл tmwgtway.csv в блокноте.
и вставить в него необходимые списки элементов - из созданных каналов сбора файла tmwgtway_rsdu2.txt
сохранить файл - tmwgtway.csv.

8. Запустить программу tmwgtway.exe.
В процессе инициализации данных - tmwgtway.exe, проверит правильность введенных Вами данных и выдаст сообщение о том, что существуют некоторое количество элементов, которые ошибочны.
Завершив программу tmwgtway.exe командой меню {Save and Exit}, и открыв файл tmwgtway.csv - можно редактировать и исправлять ошибочно введенные элементы.




====================================================================================

Алгоритм.
---------------------------------------------------------

общий алгоритм примерно такой:

1. Используя ниже построенный запрос, получаем ВСЕ НАПРАВЛЕНИЯ с которых в данный момент происходит обмен сообщениями (прием\передача):

    SELECT t.id,
          t.id_parent AS id_node,
          t.id_type,
          t.name,
          t.alias,
                    i.id_dev,
          i.ip_addr,
          I.IP_PORT
     FROM DA_CAT t, da_slave i
    WHERE     i.ID_NODE(+) = t.ID
          AND t.id_type IN (SELECT id
                              FROM da_type
                             WHERE define_alias LIKE 'DEVICE')
          AND da_get_dirtbl_f (t.id) IN (SELECT tab.id_dirtbl
                                           FROM sys_tabl_v tab, sys_tree21 tr
                                          WHERE     tr.id_lsttbl =
                                                       TAB.ID_LSTTBL
                                                AND UPPER (r_table) LIKE
                                                       'DA_V_LST%');

Результат:
ID	ID_NODE	ID_TYPE	NAME	ALIAS	IP_ADDR	IP_PORT
1000523	1000522	4	Передача в ЦСТИ	ЦСТИ	127.1.1.1	2404
3000206	3000205	4	АИИС EMCOR	Прибор	172.28.83.12	2404
4000041	4000040	4	Сбор с D200 (резервный)	Прибор	10.100.1.202	2404
6	5	4	Сбор с D200 (основной)	Прибор	10.100.1.10	2404
4000132	4000131	4	Измерительный прибор ВЛ-тест	Прибор ВЛ-тест	192.168.10.49	2406
4000169	4000168	4	Modbus	Прибор	10.100.1.10	502
4000001	4000000	4	Состояние каналов	Прибор		
4000167	4000166	4	Тест-МЭК104	Прибор	10.100.1.10	2405



2. Используя полученный в п1. id? , последовательно получаем из таблиц: da_param, da_dev_desc
список параметров (=переменных)={id, name, cvalif, ...}

select dp.id_node, dp.id , dp.name, dd.id_proto_point , dd.id_dev , 
       dd.id_parent ,  dd.cvalif , dd.id_type, sys_gtyp.define_alias  
from da_param dp, da_dev_desc dd, sys_dtyp , sys_gtyp 
where dp.id_point=dd.id  
     and sys_dtyp.id=dd.id_type 
     and sys_dtyp.id_gtype=sys_gtyp.id
     and dp.id_node=<id>

Результат:
ID_NODE	ID	NAME	ID_PROTO_POINT	ID_DEV	ID_PARENT	CVALIF	ID_TYPE	DEFINE_ALIAS
8	5000067	Uл c	13	1	1055	22534	7	GLOBAL_TYPE_ANALOG
8	5000068	Uф. ср	13	1	1055	22531	7	GLOBAL_TYPE_ANALOG
8	5000069	Iф b	13	1	1055	22537	5	GLOBAL_TYPE_ANALOG
8	5000070	Iф c	13	1	1055	22538	5	GLOBAL_TYPE_ANALOG
8	5000071	Iср	13	1	1055	22539	5	GLOBAL_TYPE_ANALOG
8	5000072	Pф a	13	1	1055	22540	8	GLOBAL_TYPE_ANALOG


3. Получаем вспомогательную информацию:

a)используя запрос, 
select DPD.id, DPD.NAME, DD.CVALIF  
from da_dev_desc dd, DA_PROTO_DESC dpd
where dd.id_dev=<id_dev> and dd.id=<da_dev_desc.id> and dpd.ID=dd.ID_PROTO_POINT
получаем id? name? cvalif? - протокола, 
так как на одном направлении может быть несколько несколько устройств с разными протоколами сбора\передачи

b)используя ID_PARENT получаем cvalif={ТИ\ТС\ТУ}

c)Определяем сессию (в терминах SCADA).
 В качестве номера сессии выбираем квалификатор Протокола
 Если протокол=104 => сессия=4
 
d)Определяем ОбщийАдрес.
 В зависимости от структуры описанного протокола.
Если протокол=MODBUS => ОбщийАдрес=""

e)В зависимости от переменной определяем тип сигнала {GLOBAL_TYPE_ANALOG?}
 из заранее заданного списка, псевдослучайным способом, выбираем формулу


5. формируем строку для записи

по правилам :  СИГНАЛ,,,,,,,,,ГРУППА,session,ASDU,address,cvalif,,,formula,,,decription,

В частности:
для протокола 104 : СИГНАЛ,,,,,,,,,ГРУППА,4,ASDU,address,cvalif,,,formula,,,decription,
для протокола Modbus: СИГНАЛ,,,,,,,,,ГРУППА,session,,address,cvalif,,,formula,,,decription,


=================================================================================================



